{% extends "base.html" %}
{% block title %}{{ incident_id }} - Case Study{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
  <div>
    <h1 class="mb-1">{{ incident_id }} — Incident Case Study</h1>
    <p class="text-muted mb-0">
      <strong>Title:</strong> {{ title }}
    </p>
  </div>
  <div class="text-end">
    <div class="badge bg-secondary">Severity: {{ severity }}</div>
    <div class="small text-muted mt-1">Status: {{ status }}</div>
  </div>
</div>

<hr>
<!-- Trace log Navigation -->
<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'trace-logs-page' %}">Trace Logs</a>
  <a class="btn btn-sm btn-outline-danger" href="{% url 'trace-logs-page' %}?review_required=1">Exceptions</a>
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'trace-ingest-page' %}">Trace Ingest</a>

  {% if request.session.last_trace_id %}
    <a class="btn btn-sm btn-outline-primary"
       href="{% url 'trace-detail-page' trace_id=request.session.last_trace_id %}">
      Open Last Trace: {{ request.session.last_trace_id }}
    </a>
  {% endif %}
</div>


<!-- Executive Summary -->
<section class="mb-4">
  <h3>Executive Summary (30 seconds)</h3>
  <ul>
    <li><strong>Symptoms:</strong> HL7 ingestion shows “success”, but downstream resource creation is incomplete (e.g., Encounter missing).</li>
    <li><strong>Impact:</strong> Claim generation or downstream analytics becomes unreliable; reconciliation can mismatch.</li>
    <li><strong>Scope:</strong> Time window: <code>YYYY-MM-DD HH:MM</code> — <code>YYYY-MM-DD HH:MM</code>; impacted records: <code>N</code>.</li>
    <li><strong>Current State:</strong> {{ status }}</li>
  </ul>

  <div class="small text-muted">
    Tags:
    {% for t in tags %}
      <span class="badge text-bg-light border">{{ t }}</span>
    {% endfor %}
  </div>
</section>

<!-- Timeline -->
<section class="mb-4">
  <h3>Timeline</h3>
  <ul>
    <li><strong>T0 Detect:</strong> Detected via Exceptions / QA checks.</li>
    <li><strong>T1 Triage:</strong> Located correlation id in Traceability.</li>
    <li><strong>T2 Root Cause:</strong> Confirmed mapping/validation issue.</li>
    <li><strong>T3 Fix:</strong> Implemented guardrail + mapping change.</li>
    <li><strong>T4 Verify:</strong> Replay/backfill + reconciliation metrics improved.</li>
  </ul>
</section>

<!-- Investigation -->
<section class="mb-4">
  <h3>How I Investigated (Repeatable Runbook)</h3>
  <ol>
    <li>
      <strong>Traceability:</strong> Locate the record and capture correlation id.
      <div class="small text-muted">
        Tip: use <em>Trace Logs</em> and filter by time window / review-required exceptions.
      </div>
    </li>
    <li>
      <strong>HL7MessageLog:</strong> Validate raw payload and parse results; identify missing/invalid fields.
    </li>
    <li>
      <strong>Normalization/Mapping:</strong> Inspect transform rules for null/optional field edge cases.
    </li>
    <li>
      <strong>Downstream Verification:</strong> Confirm resource state + claim lifecycle + reconciliation outcome.
    </li>
  </ol>
</section>

<!-- Evidence -->
<section class="mb-4">
  <h3>Evidence</h3>
  <ul>
        <li>
            <strong>Evidence #1 (Trace shows partial success):</strong>
            Trace indicates HL7 ingestion step succeeded, but a downstream step is missing/failed (Encounter not created).
            Use <a href="{% url 'trace-logs-page' %}?review_required=1">Exceptions</a> to find “review required” traces.
        </li>

        <li>
            <strong>Evidence #2 (Parsed HL7 payload is valid):</strong>
            HL7 parse/validation shows the message format is acceptable (no fatal parsing error),
            so the failure is likely in mapping/normalization.
        </li>

        <li>
            <strong>Evidence #3 (Mapping edge case):</strong>
            A required Encounter-building field is empty or not mapped (common examples: visit number, PV1 fields, attending doctor fields).
            This results in “Patient created” but “Encounter missing.”
        </li>

        <li>
            <strong>Evidence #4 (Downstream impact visible):</strong>
            Claim/reconciliation (or any downstream dependency) cannot proceed reliably without Encounter,
            causing mismatches or incomplete lifecycle data.
        </li>
  </ul>
</section>

<!-- Root Cause -->
<section class="mb-4">
  <h3>Root Cause</h3>
  <p>
    <strong>Primary cause:</strong> HL7 parsing succeeded, but Encounter creation was gated on a field that was
    missing/empty in certain messages (or not mapped during normalization). As a result, the pipeline produced a
    misleading “success” signal at ingestion while downstream resources were incomplete.
    </p>
    <p>
        <strong>Contributing cause:</strong> The system did not flag “partial success” clearly enough (no explicit
        validation/alerting when Encounter is absent but Patient exists).
    </p>
</section>

<!-- Fix -->
<section class="mb-4">
  <h3>Fix</h3>
  <ul>
    <li>
        <strong>Short-term mitigation:</strong>
        If Encounter-required fields are missing, mark the trace as <em>review_required</em> (or reject with a clear message)
        so the issue is visible instead of silently producing incomplete records.
    </li>
    <li>
        <strong>Long-term fix:</strong>
        Update normalization/mapping to handle optional fields safely, and define a deterministic rule:
        either (A) create Encounter with defaults + warnings, or (B) reject and require correction.
    </li>
    <li>
        <strong>Rollback strategy:</strong>
        If the change increases false rejects or reduces throughput, revert mapping version and keep the alerting guardrail.
    </li>
  </ul>
</section>

<!-- Validation -->
<section class="mb-4">
  <h3>Validation</h3>
  <ul>
    <li><strong>Replay:</strong> re-run the same message/correlation id and confirm every step succeeds.</li>
    <li><strong>Metrics:</strong> mapping success rate ↑, reject rate becomes “honest”, reconciliation match ↑.</li>
  </ul>
</section>

<!-- Communication -->
<section class="mb-4">
  <h3>Communication Outputs (Analyst Deliverables)</h3>
  <ul>
    <li><strong>Partner/Customer:</strong> request 3 sample messages + timestamps + system version; confirm expected field availability.</li>
    <li><strong>Engineering:</strong> minimal reproduction + correlation id + mapping rule + expected vs actual.</li>
    <li><strong>Stakeholders:</strong> impact summary + mitigation + ETA + verification plan.</li>
  </ul>
</section>

<!-- Prevention -->
<section class="mb-4">
  <h3>Prevention</h3>
  <ul>
    <li>Add validation guardrails for required fields and a clear “partial success” status.</li>
    <li>Add automated tests for missing/empty-field scenarios.</li>
    <li>Add monitoring/alerts when partial success exceeds a threshold.</li>
  </ul>
</section>
{% endblock %}
