{% extends "base.html" %}
{% block title %}{{ incident_id }} - Case Study{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
  <div>
    <h1 class="mb-1">{{ incident_id }} — Incident Case Study</h1>
    <p class="text-muted mb-0">
      <strong>Title:</strong> {{ title }}
    </p>
  </div>
  <div class="text-end">
    <div class="badge bg-secondary">Severity: {{ severity }}</div>
    <div class="small text-muted mt-1">Status: {{ status }}</div>
  </div>
</div>

<hr>

<!-- Executive Summary -->
<section class="mb-4">
  <h3>Executive Summary (30 seconds)</h3>
  <ul>
    <li><strong>Symptoms:</strong> HL7 ingestion shows “success”, but downstream resource creation is incomplete (e.g., Encounter missing).</li>
    <li><strong>Impact:</strong> Claim generation or downstream analytics becomes unreliable; reconciliation can mismatch.</li>
    <li><strong>Scope:</strong> Time window: <code>YYYY-MM-DD HH:MM</code> — <code>YYYY-MM-DD HH:MM</code>; impacted records: <code>N</code>.</li>
    <li><strong>Current State:</strong> {{ status }}</li>
  </ul>

  <div class="small text-muted">
    Tags:
    {% for t in tags %}
      <span class="badge text-bg-light border">{{ t }}</span>
    {% endfor %}
  </div>
</section>

<!-- Timeline -->
<section class="mb-4">
  <h3>Timeline</h3>
  <ul>
    <li><strong>T0 Detect:</strong> Detected via Exceptions / QA checks.</li>
    <li><strong>T1 Triage:</strong> Located correlation id in Traceability.</li>
    <li><strong>T2 Root Cause:</strong> Confirmed mapping/validation issue.</li>
    <li><strong>T3 Fix:</strong> Implemented guardrail + mapping change.</li>
    <li><strong>T4 Verify:</strong> Replay/backfill + reconciliation metrics improved.</li>
  </ul>
</section>

<!-- Investigation -->
<section class="mb-4">
  <h3>How I Investigated (Repeatable Runbook)</h3>
  <ol>
    <li>
      <strong>Traceability:</strong> Locate the record and capture correlation id.
      <div class="small text-muted">
        Tip: use <em>Trace Logs</em> and filter by time window / review-required exceptions.
      </div>
    </li>
    <li>
      <strong>HL7MessageLog:</strong> Validate raw payload and parse results; identify missing/invalid fields.
    </li>
    <li>
      <strong>Normalization/Mapping:</strong> Inspect transform rules for null/optional field edge cases.
    </li>
    <li>
      <strong>Downstream Verification:</strong> Confirm resource state + claim lifecycle + reconciliation outcome.
    </li>
  </ol>
</section>

<!-- Evidence -->
<section class="mb-4">
  <h3>Evidence</h3>
  <ul>
    <li><strong>Evidence #1:</strong> Traceability step shows “partial success” signal (needs review).</li>
    <li><strong>Evidence #2:</strong> HL7 parse indicates <code>SEG.FIELD</code> missing/empty.</li>
    <li><strong>Evidence #3:</strong> Mapping rule overwrote/dropped the field required to build Encounter.</li>
    <li><strong>Evidence #4:</strong> Reconciliation mismatch: expected vs actual for <code>claim_id</code>.</li>
  </ul>
  <div class="alert alert-info mb-0">
    Replace the evidence bullets with links to your actual pages/log entries (Trace detail, log detail, etc.).
  </div>
</section>

<!-- Root Cause -->
<section class="mb-4">
  <h3>Root Cause</h3>
  <p>
    Primary cause: a mapping rule incorrectly handled an optional HL7 field when the value is empty, leading to missing Encounter creation.
    Contributing cause: lack of explicit validation/alerting for partial-success states.
  </p>
</section>

<!-- Fix -->
<section class="mb-4">
  <h3>Fix</h3>
  <ul>
    <li><strong>Short-term mitigation:</strong> reject + surface a clear error when required fields are missing (avoid silent partial success).</li>
    <li><strong>Long-term fix:</strong> update mapping to handle empty values safely; add regression tests for this edge case.</li>
    <li><strong>Rollback strategy:</strong> revert mapping version if reconciliation match rate drops.</li>
  </ul>
</section>

<!-- Validation -->
<section class="mb-4">
  <h3>Validation</h3>
  <ul>
    <li><strong>Replay:</strong> re-run the same message/correlation id and confirm every step succeeds.</li>
    <li><strong>Metrics:</strong> mapping success rate ↑, reject rate becomes “honest”, reconciliation match ↑.</li>
  </ul>
</section>

<!-- Communication -->
<section class="mb-4">
  <h3>Communication Outputs (Analyst Deliverables)</h3>
  <ul>
    <li><strong>Partner/Customer:</strong> request 3 sample messages + timestamps + system version; confirm expected field availability.</li>
    <li><strong>Engineering:</strong> minimal reproduction + correlation id + mapping rule + expected vs actual.</li>
    <li><strong>Stakeholders:</strong> impact summary + mitigation + ETA + verification plan.</li>
  </ul>
</section>

<!-- Prevention -->
<section class="mb-4">
  <h3>Prevention</h3>
  <ul>
    <li>Add validation guardrails for required fields and a clear “partial success” status.</li>
    <li>Add automated tests for missing/empty-field scenarios.</li>
    <li>Add monitoring/alerts when partial success exceeds a threshold.</li>
  </ul>
</section>
{% endblock %}
