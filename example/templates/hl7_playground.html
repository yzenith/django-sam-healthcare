{% extends "base.html" %}

{% block title %}HL7 v2 → FHIR → X12 837 Playground{% endblock %}

{% block content %}
  <div class="row mb-4">
    <div class="col-lg-10">
      <h1 class="mb-3">HL7 v2 → FHIR → X12 837 Playground</h1>
      <p class="text-muted">
        Paste an HL7 v2 ADT/ORU message below. The API will convert it into FHIR
        <strong>Patient</strong> / <strong>Encounter</strong> / <strong>DiagnosticReport</strong>
        / <strong>Observations</strong>, and generate a simplified
        <strong>X12 837</strong> claim.
      </p>
    </div>
  </div>

  <div class="row g-4">
    <!-- Input card -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Step 1: Paste HL7 v2 Message</h5>
          <p class="card-text small text-muted mb-2">
            You can paste a single HL7 ADT/ORU message here. In the future this
            page can be extended to support HL7 batches (multiple messages).
          </p>
          <textarea id="hl7-input"
                    class="form-control font-monospace"
                    rows="10">MSH|^~\&|ADT|HOSP|EHR|HOSP|202501291200||ADT^A01|123456|P|2.4
PID|1||123456^^^HOSP^MR||DOE^JOHN||19900520|M|||789 PINE ST^^ALLEN^TX^75013
PV1|1|I|2000^2012^01||||12345^SMITH^JANE|||SUR||||ADM||||</textarea>
          <button id="btn-transform" class="btn btn-primary mt-3">
            Transform HL7
          </button>
        </div>
      </div>
    </div>

    <!-- FHIR Patient -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">FHIR Patient</h5>
          <pre id="patient-json"
               class="bg-light border rounded p-3 small mb-0">(Results will appear here)</pre>
        </div>
      </div>
    </div>

    <!-- FHIR Encounter -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">FHIR Encounter</h5>
          <pre id="encounter-json"
               class="bg-light border rounded p-3 small mb-0">(Results will appear here)</pre>
        </div>
      </div>
    </div>

    <!-- FHIR DiagnosticReport (ORU) -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">FHIR DiagnosticReport (ORU)</h5>
          <pre id="report-json"
               class="bg-light border rounded p-3 small mb-0">(ORU results will appear here)</pre>
        </div>
      </div>
    </div>

    <!-- FHIR Observations (ORU) -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">FHIR Observations (ORU)</h5>
          <pre id="obs-json"
               class="bg-light border rounded p-3 small mb-0">(ORU results will appear here)</pre>
        </div>
      </div>
    </div>

    <!-- X12 837 -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Generated X12 837 Claim</h5>
          <pre id="x12-837"
               class="bg-light border rounded p-3 small mb-0">(Results will appear here)</pre>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  $(function () {
    $("#btn-transform").on("click", function () {
      const hl7 = $("#hl7-input").val();

      // Clear all previous results
      $("#patient-json").text("(Results will appear here)");
      $("#encounter-json").text("(Results will appear here)");
      $("#x12-837").text("(Results will appear here)");
      $("#report-json").text("(ORU results will appear here)");
      $("#obs-json").text("(ORU results will appear here)");

      $.ajax({
        url: "{% url 'hl7-transform' %}",
        method: "POST",
        contentType: "application/json",
        dataType: "json",
        data: JSON.stringify({ hl7_message: hl7 }),

        success: function (data) {
          if (data.patient) {
            $("#patient-json").text(JSON.stringify(data.patient, null, 2));
          }
          if (data.encounter) {
            $("#encounter-json").text(JSON.stringify(data.encounter, null, 2));
          }
          if (data.x12_837) {
            $("#x12-837").text(data.x12_837);
          }
          if (data.report) {
            $("#report-json").text(JSON.stringify(data.report, null, 2));
          }
          if (data.observations) {
            $("#obs-json").text(JSON.stringify(data.observations, null, 2));
          }
        },

        error: function (xhr) {
          alert("Error: " + (xhr.responseText || xhr.statusText));
        }
      });
    });
  });
</script>
{% endblock %}
