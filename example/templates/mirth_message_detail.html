{% extends "base.html" %}

{% block title %}Message #{{ log.id }} – HL7 Detail{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-lg-8">
    <nav aria-label="breadcrumb" class="mb-2">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'mirth-messages' %}">Mirth Messages</a></li>
        <li class="breadcrumb-item active" aria-current="page">
          Message #{{ log.id }}
        </li>
      </ol>
    </nav>
    <h1 class="h3 mb-1">HL7 Message #{{ log.id }}</h1>
    <p class="text-muted mb-0">
      Details for an HL7 message received from <strong>Mirth Connect</strong>,
      including the raw HL7 payload, parsed FHIR resources, and generated X12 837.
    </p>
  </div>
</div>

<div class="row g-3">
  <!-- Metadata card -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Message Metadata</h5>
        <dl class="row mb-0 small">
          <dt class="col-sm-3">Received at</dt>
          <dd class="col-sm-9">{{ log.created_at|date:"Y-m-d H:i:s" }}</dd>

          <dt class="col-sm-3">Source system</dt>
          <dd class="col-sm-9">{{ log.source_system|default:"(unknown)" }}</dd>

          <dt class="col-sm-3">Message type</dt>
          <dd class="col-sm-9">{{ log.message_type }}</dd>

          <dt class="col-sm-3">Patient ID</dt>
          <dd class="col-sm-9">{{ log.patient_id|default:"—" }}</dd>

          <dt class="col-sm-3">Encounter?</dt>
          <dd class="col-sm-9">
            {% if log.encounter_present %}
              <span class="badge bg-success-subtle text-success-emphasis">Yes</span>
            {% else %}
              <span class="badge bg-secondary-subtle text-secondary-emphasis">No</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">837 length</dt>
          <dd class="col-sm-9">
            {% if log.x12_length %}
              {{ log.x12_length }} chars
            {% else %}
              —
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <!-- Raw HL7 -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Raw HL7 v2 Message</h5>
        <pre class="bg-light border rounded p-3 small mb-0">{{ log.raw_hl7 }}</pre>
      </div>
    </div>
  </div>

  <!-- FHIR Patient -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">FHIR Patient (JSON)</h5>
        {% if patient %}
          {{ patient|json_script:"patient-json" }}
          <pre id="patient-json-display"
               class="bg-light border rounded p-3 small mb-0"></pre>
        {% else %}
          <pre class="bg-light border rounded p-3 small mb-0">
(No Patient resource generated for this message.)
          </pre>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- FHIR Encounter -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">FHIR Encounter (JSON)</h5>
        {% if encounter %}
          {{ encounter|json_script:"encounter-json" }}
          <pre id="encounter-json-display"
               class="bg-light border rounded p-3 small mb-0"></pre>
        {% else %}
          <pre class="bg-light border rounded p-3 small mb-0">
(No Encounter resource generated for this message.)
          </pre>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- X12 837 -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Generated X12 837</h5>
        <pre class="bg-light border rounded p-3 small mb-0">
{{ x12_837|default:"(No X12 837 generated for this message.)" }}
        </pre>
      </div>
    </div>
  </div>

  {% if log.message_type == "ORU^R01" %}
    <!-- DiagnosticReport -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">FHIR DiagnosticReport</h5>
          <pre class="bg-light border rounded p-3 small mb-0">
{{ report_json|default:"(No DiagnosticReport generated for this message.)" }}
          </pre>
        </div>
      </div>
    </div>

    <!-- Observations -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">FHIR Observations (Lab Results)</h5>
          <pre class="bg-light border rounded p-3 small mb-0">
{{ observations_json|default:"(No Observations generated for this message.)" }}
          </pre>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Pretty-print the JSON from the json_script tags
  function showJson(id, displayId) {
    const script = document.getElementById(id);
    if (!script) return;
    try {
      const data = JSON.parse(script.textContent || script.innerText || "{}");
      const el = document.getElementById(displayId);
      if (el) {
        el.textContent = JSON.stringify(data, null, 2);
      }
    } catch (e) {
      console.error("Failed to parse JSON for", id, e);
    }
  }

  showJson("patient-json", "patient-json-display");
  showJson("encounter-json", "encounter-json-display");
</script>
{% endblock %}
