<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Message #{{ log.id }} â€“ HL7 Detail</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f9ff; margin: 0; }
    .nav { background: #0f4c81; color: #fff; padding: 12px 24px; }
    .nav a { color: #fff; text-decoration: none; margin-right: 16px; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border-radius:8px; padding:16px 20px;
            box-shadow:0 2px 8px rgba(0,0,0,.08); margin-bottom:20px; }
    pre { background:#f5f5f5; padding:12px; border-radius:6px; overflow-x:auto;
          white-space:pre-wrap; font-size:13px; }
    h2, h3 { margin-top:0; }
    .meta-table { width:100%; border-collapse:collapse; font-size:14px; }
    .meta-table td { padding:4px 8px; }
    .meta-table td.label { font-weight:bold; width:140px; color:#555; }
  </style>
</head>
<body>
<div class="nav">
  <a href="/">Home</a>
  <a href="/mirth/messages/">Mirth Messages</a>
  <span> / Message #{{ log.id }}</span>
</div>

<div class="container">

  <div class="card">
    <h2>HL7 Message #{{ log.id }}</h2>
    <table class="meta-table">
      <tr><td class="label">Received at</td><td>{{ log.created_at }}</td></tr>
      <tr><td class="label">Source system</td><td>{{ log.source_system }}</td></tr>
      <tr><td class="label">Message type</td><td>{{ log.message_type }}</td></tr>
      <tr><td class="label">Patient ID</td><td>{{ log.patient_id }}</td></tr>
      <tr><td class="label">Encounter?</td><td>{{ log.encounter_present }}</td></tr>
      <tr><td class="label">837 length</td><td>{{ log.x12_length }}</td></tr>
    </table>
  </div>


  <div class="card">
    <h3>Raw HL7 v2 Message</h3>
    <pre>{{ log.raw_hl7 }}</pre>
  </div>

  <div class="card">
    <h3>FHIR Patient (JSON)</h3>
    <pre>{{ patient|json_script:"patient-json" }}</pre>
    <pre id="patient-json-display"></pre>
  </div>

  <div class="card">
    <h3>FHIR Encounter (JSON)</h3>
    <pre>{{ encounter|json_script:"encounter-json" }}</pre>
    <pre id="encounter-json-display"></pre>
  </div>

  <div class="card">
    <h3>Generated X12 837</h3>
    <pre>{{ x12_837 }}</pre>
  </div>

  {% if log.message_type == "ORU^R01" %}
    <div class="card">
    <h3>FHIR DiagnosticReport</h3>
    <pre>{{ report_json }}</pre>
    </div>

    <div class="card">
    <h3>FHIR Observations (Lab Results)</h3>
    <pre>{{ observations_json }}</pre>
    </div>
  {% endif %}


</div>

<script>
  // Pretty-print the JSON from the json_script tags
  function showJson(id, displayId) {
    const script = document.getElementById(id);
    if (!script) return;
    const data = JSON.parse(script.textContent || script.innerText || "{}");
    document.getElementById(displayId).textContent = JSON.stringify(data, null, 2);
  }

  showJson("patient-json", "patient-json-display");
  showJson("encounter-json", "encounter-json-display");
</script>

</body>
</html>
