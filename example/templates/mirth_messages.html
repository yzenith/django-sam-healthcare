{% extends "base.html" %}

{% block title %}Mirth Live Feed – Recent HL7 Messages{% endblock %}

{% block content %}
  <div class="row mb-4">
    <div class="col-lg-8">
      <h1 class="mb-2">Mirth Live Feed</h1>
      <p class="text-muted mb-0">
        Recent HL7 messages received from <strong>Mirth Connect</strong> and logged
        through the Django API. Click a row to inspect the full HL7 payload and
        related FHIR / X12 artifacts.
      </p>
    </div>
  </div>

  <!-- Summary cards (optional, but looks very "dashboard") -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase small mb-2">Total Messages</h6>
          <div class="fs-4 fw-semibold">{{ logs|length }}</div>
          <div class="small text-muted">Stored in Neon Postgres</div>
        </div>
      </div>
    </div>

    <!-- With Encounter (placeholder for now) -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase small mb-2">With Encounter</h6>
          <div class="fs-4 fw-semibold">
            —  {# placeholder, we removed the buggy expression #}
          </div>
          <div class="small text-muted">Parsed encounter segments (PV1)</div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase small mb-2">From Mirth</h6>
          <div class="fs-4 fw-semibold">HTTP Channel</div>
          <div class="small text-muted">Secured by HMAC (demo)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages table -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">Recent HL7 Messages</h5>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Time</th>
              <th scope="col">Type</th>
              <th scope="col">Patient ID</th>
              <th scope="col">Encounter?</th>
              <th scope="col">837 Length</th>
              <th scope="col">HL7 (preview)</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
              <tr>
                <td class="small text-nowrap">
                  {{ log.created_at|date:"Y-m-d H:i:s" }}
                </td>
                <td>
                  <span class="badge bg-primary-subtle text-primary-emphasis">
                    {{ log.message_profile|default:log.message_type }}
                  </span>
                </td>
                <td class="small">
                  {{ log.patient_id|default:"—" }}
                </td>
                <td>
                  {% if log.encounter_present %}
                    <span class="badge bg-success-subtle text-success-emphasis">Yes</span>
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary-emphasis">No</span>
                  {% endif %}
                </td>
                <td class="small">
                  {% if log.x12_length %}
                    {{ log.x12_length }} chars
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="small">
                  <a href="{% url 'mirth-message-detail' log.pk %}" class="text-decoration-none">
                    {{ log.raw_hl7|truncatechars:100 }}
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No messages yet. Configure your Mirth channel to POST HL7
                  messages to the demo endpoint.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
{% endblock %}
